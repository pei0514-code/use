<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>È∫•È∫•ÈõªÂ≠êÁ•®Âà∏ÂïÜÂüé</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --brand-red: #DA291C; --brand-dark: #27251F; --brand-yellow: #FFC72C; --line-green: #06C755; }
        body { background-color: #f7f8fa; padding-bottom: 120px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        #static-loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 45px; height: 45px; border: 4px solid #f3f3f3; border-top-color: var(--brand-red); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Header */
        .sticky-header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; }
        
        /* Category Tabs */
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 15px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 6px 18px; border-radius: 50px; font-size: 13px; font-weight: bold; white-space: nowrap; border: 1px solid #eee; background: #fff; color: #999; transition: 0.3s; }
        .cat-btn.active { background: var(--brand-dark); color: #fff; border-color: var(--brand-dark); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Product Cards */
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; border: 1px solid #f0f0f0; position: relative; transition: transform 0.2s; }
        .product-card:active { transform: scale(0.98); }
        .product-card.sold-out { filter: grayscale(100%); opacity: 0.6; }
        .product-card.sold-out::after { content: "SOLD OUT"; position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.7); color: white; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; z-index: 10; }
        
        .p-img-box { position: relative; width: 100%; padding-top: 100%; background: #f0f0f0; }
        .p-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .p-title { font-weight: 700; font-size: 14px; margin-bottom: 6px; color: #222; line-height: 1.4; height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .p-info { font-size: 10px; color: #999; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .stock-tag { background: #fdf2f2; color: #d32f2f; padding: 1px 6px; border-radius: 4px; font-weight: bold; }
        
        .p-price { color: var(--brand-red); font-weight: 800; font-size: 19px; }
        .p-price-old { font-size: 11px; text-decoration: line-through; color: #ccc; margin-left: 4px; }
        
        .btn-buy { background: var(--brand-dark); color: white; border: none; padding: 10px 0; border-radius: 50px; font-size: 13px; font-weight: bold; width: 100%; margin-top: auto; }
        .qty-ctrl { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 50px; padding: 4px; border: 1px solid #eee; margin-top: auto; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Floating Cart Bar */
        .cart-bar { position: fixed; bottom: 25px; left: 15px; right: 15px; background: var(--brand-red); color: white; padding: 15px 25px; border-radius: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 12px 30px rgba(218, 41, 28, 0.4); z-index: 1000; cursor: pointer; transition: 0.3s; }
        .cart-bar:active { transform: scale(0.95); }
        .cart-qty-badge { background: white; color: var(--brand-red); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; margin-right: 12px; }

        /* Modals */
        .modal-content { border: none; border-radius: 30px; overflow: hidden; }
        .gift-box { background: #fff4f4; border: 1px dashed var(--brand-red); border-radius: 15px; padding: 10px; margin-top: 15px; display: flex; align-items: center; gap: 10px; }
        .btn-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .btn-action { border: none; border-radius: 18px; padding: 16px 8px; font-weight: bold; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 6px; color: white; transition: 0.2s; }
        .btn-line { background: var(--line-green); }
        .btn-copy { background: var(--brand-dark); }
        
        [v-cloak] { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body>

    <!-- ËºâÂÖ•Â±§ -->
    <div id="static-loader">
        <div class="spinner"></div>
        <div class="mt-3 text-secondary small fw-bold">È∫•È∫•ÂïÜÂüé V121 ËºâÂÖ•‰∏≠</div>
        <div id="timeout-msg" class="text-muted mt-2 small" style="display:none">‰º∫ÊúçÂô®ÈüøÊáâËºÉÊÖ¢ÔºåË´ãÁ®çÂÄô...</div>
    </div>

    <div id="app" v-cloak>
        <!-- Header -->
        <div class="sticky-header">
            <div class="p-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 40px; height: 40px; font-style: italic; font-size: 20px;">M</div>
                    <div>
                        <div class="fw-bold text-dark" style="font-size: 14px;">È∫•È∫•ÂïÜÂüé <span class="badge bg-light text-muted border fw-normal" style="font-size: 9px;">{{ settings.version }}</span></div>
                        <div class="text-muted" style="font-size: 11px;">Hi, {{ userProfile.displayName || 'Ë®™ÂÆ¢' }}</div>
                    </div>
                </div>
                <div class="text-muted"><i class="fas fa-history"></i></div>
            </div>
            
            <div class="category-scroll">
                <button 
                    class="cat-btn" 
                    :class="{ active: currentCat === 'ALL' }" 
                    @click="currentCat = 'ALL'">ÂÖ®ÈÉ®</button>
                <button 
                    v-for="cat in categories" 
                    :key="cat"
                    class="cat-btn" 
                    :class="{ active: currentCat === cat }" 
                    @click="currentCat = cat">{{ cat }}</button>
            </div>
        </div>

        <!-- ÂïÜÂìÅÂàóË°® -->
        <div class="container-fluid px-2 py-3">
            <div class="row g-2">
                <div class="col-6 col-md-4" v-for="p in filteredProducts" :key="p.id">
                    <div class="product-card" :class="{ 'sold-out': Number(p.stock) <= 0 }">
                        <div class="p-img-box">
                            <img :src="p.image || 'https://via.placeholder.com/300?text=No+Image'" class="p-img" loading="lazy">
                        </div>
                        <div class="p-body">
                            <div class="p-title">{{ p.name }}</div>
                            <div class="p-info">
                                <span>ÊïàÊúü: {{ p.expiryDate }}</span>
                                <span class="stock-tag">Â∫´Â≠ò: {{ p.stock }}</span>
                            </div>
                            <div class="mb-2">
                                <span class="p-price">${{ p.price }}</span>
                                <span v-if="p.originalPrice" class="p-price-old">${{ p.originalPrice }}</span>
                            </div>
                            
                            <div v-if="cart[p.id]" class="qty-ctrl">
                                <button class="qty-btn" @click.stop="updateCart(p, -1)"><i class="fas fa-minus"></i></button>
                                <span class="fw-bold">{{ cart[p.id] }}</span>
                                <button class="qty-btn" @click.stop="updateCart(p, 1)"><i class="fas fa-plus"></i></button>
                            </div>
                            <button v-else class="btn-buy" @click.stop="updateCart(p, 1)">
                                {{ Number(p.stock) <= 0 ? 'Ë£úË≤®‰∏≠' : 'Âä†ÂÖ•Ë≥ºÁâ©Ëªä' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë≥ºÁâ©ËªäÊµÆÂãïÊ¢ù -->
        <div class="cart-bar" v-if="totalQty > 0" @click="openCart">
            <div class="d-flex align-items-center">
                <div class="cart-qty-badge">{{ totalQty }}</div>
                <div class="fw-bold fs-5">${{ totalPrice }}</div>
            </div>
            <div class="fw-bold">ÂéªÁµêÂ∏≥ <i class="fas fa-chevron-right ms-2"></i></div>
        </div>

        <!-- ÁµêÂ∏≥ Modal -->
        <div class="modal fade" id="cartModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content shadow-lg">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="fw-bold">Á¢∫Ë™çË®ÇÂñÆÂÖßÂÆπ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div v-for="item in cartItems" :key="item.id" class="d-flex justify-content-between py-2 border-bottom border-light">
                                <div class="small">{{ item.name }} x {{ item.qty }}</div>
                                <div class="fw-bold text-danger">${{ item.price * item.qty }}</div>
                            </div>
                        </div>

                        <div v-if="activeGift" class="gift-box">
                            <i class="fas fa-gift text-danger fs-4"></i>
                            <div>
                                <div class="fw-bold text-danger small">ÊªøÈ°çË¥àÁ¶Æ</div>
                                <div class="text-muted" style="font-size: 11px;">{{ activeGift }}</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between fw-bold fs-5 p-3 bg-light rounded-4 mt-3">
                            <span>Êáâ‰ªòÁ∏ΩÈ°ç</span>
                            <span class="text-danger">${{ totalPrice }}</span>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-danger w-100 rounded-pill py-3 fw-bold shadow-sm" @click="handleCheckout" :disabled="isSubmitting">
                            {{ isSubmitting ? 'Ê≠£Âú®ÂÇ≥ÈÄÅ‰∏≠...' : 'Á¢∫Ë™ç‰∏¶ÈÄÅÂá∫Ë®ÇÂñÆ' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊàêÂäü Modal -->
        <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-4">
                    <div class="mb-3 text-success"><i class="fas fa-check-circle fa-4x"></i></div>
                    <h4 class="fw-bold">Ë®ÇÂñÆÂ∑≤Â∞±Á∑í</h4>
                    <p class="text-muted small mb-4">Ë´ãÈÅ∏Âèñ„ÄåÂàÜ‰∫´Â•ΩÂèã„ÄçÂ∞áÊñáÂ≠óÂÇ≥ÈÄÅÁµ¶ÂÆ¢Êúç„ÄÇ</p>
                    
                    <div class="p-3 bg-light rounded-4 text-start mb-4 border" style="font-size: 10px; max-height: 150px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">{{ finalMsg }}</pre>
                    </div>
                    
                    <div class="btn-action-group">
                        <button class="btn-action btn-line" @click="shareToLine">
                            <i class="fab fa-line fa-2x"></i>
                            <span>ÂÇ≥ÈÄÅÁµ¶ÂÆ¢Êúç</span>
                        </button>
                        <button class="btn-action btn-copy" @click="copyText">
                            <i class="fas fa-copy fa-2x"></i>
                            <span>{{ hasCopied ? 'Â∑≤Ë§áË£Ω' : 'Ë§áË£ΩË®ÇÂñÆ' }}</span>
                        </button>
                    </div>
                    <button class="btn btn-link text-muted mt-3 small text-decoration-none" @click="closeSuccess">ÂõûÂïÜÂüé</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        // Ê†∏ÂøÉË®≠ÂÆöÔºöÊÇ®ÁöÑ GAS API Á∂≤ÂùÄ
        const API_URL = 'https://script.google.com/macros/s/AKfycbx2xdqkRoBGFibvgKRo05QtVcIWZlUjBq-rr_NRJ-8nK1BsFPSorQqnsNa89IPlG45aeA/exec';

        createApp({
            setup() {
                const products = ref([]);
                const settings = ref({ version: 'v121', bankInfo: '' });
                const cart = ref({});
                const currentCat = ref('ALL');
                const userProfile = ref({ displayName: '', userId: '' });
                const isSubmitting = ref(false);
                const hasCopied = ref(false);
                const finalMsg = ref('');
                
                let cartModal = null;
                let successModal = null;

                const loadData = async () => {
                    // Ë∂ÖÊôÇÊèêÁ§∫
                    const timer = setTimeout(() => {
                        const el = document.getElementById('timeout-msg');
                        if (el) el.style.display = 'block';
                    }, 4000);

                    try {
                        const [prodRes, settRes] = await Promise.all([
                            fetch(`${API_URL}?action=getInitData`).then(r => r.json()),
                            fetch(`${API_URL}?action=getSettings`).then(r => r.json())
                        ]);

                        if (prodRes.products) products.value = prodRes.products;
                        if (settRes) settings.value = settRes;

                        // ÂàùÂßãÂåñ LIFF
                        if (settRes.liffId) {
                            await liff.init({ liffId: settRes.liffId });
                            if (liff.isLoggedIn()) {
                                userProfile.value = await liff.getProfile();
                            }
                        }
                    } catch (e) {
                        console.error("API Error", e);
                    } finally {
                        clearTimeout(timer);
                        const loader = document.getElementById('static-loader');
                        if (loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => loader.style.display = 'none', 500);
                        }
                    }
                };

                onMounted(() => {
                    loadData();
                    cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
                    successModal = new bootstrap.Modal(document.getElementById('successModal'));
                });

                // Ë≥ºÁâ©ÈÇèËºØ
                const updateCart = (p, d) => {
                    const current = cart.value[p.id] || 0;
                    const next = current + d;
                    if (next <= 0) {
                        delete cart.value[p.id];
                    } else if (next <= (p.stock || 999)) {
                        cart.value[p.id] = next;
                    }
                };

                const categories = computed(() => [...new Set(products.value.map(p => p.category).filter(Boolean))]);
                const filteredProducts = computed(() => currentCat.value === 'ALL' ? products.value : products.value.filter(p => p.category === currentCat.value));
                const cartItems = computed(() => Object.keys(cart.value).map(id => {
                    const p = products.value.find(x => x.id === id);
                    return p ? { ...p, qty: cart.value[id] } : null;
                }).filter(x => x));
                
                const totalQty = computed(() => cartItems.value.reduce((a, b) => a + b.qty, 0));
                const totalPrice = computed(() => cartItems.value.reduce((a, b) => a + (b.price * b.qty), 0));
                const activeGift = computed(() => {
                    if (totalPrice.value >= 999) return "C.3 Ë±¨ËÇâÊªøÁ¶èÂ†°Âä†ËõãÂä†‰∏≠ÂÜ∞ÁæéÂºè (‰∏ÄÁµÑ)";
                    if (totalPrice.value >= 500) return "A.3 Â§ßËõãÊç≤ÂÜ∞Ê∑áÊ∑ã Êàñ A.7 Êº¢Â†° (‰∫åÈÅ∏‰∏Ä)";
                    return null;
                });

                // ÁµêÂ∏≥ÈÇèËºØ
                const handleCheckout = async () => {
                    if (isSubmitting.value) return;
                    isSubmitting.value = true;
                    
                    const orderId = 'M' + Date.now().toString().slice(-6);
                    const itemsStr = cartItems.value.map((i, idx) => `${idx + 1}„ÄÅ${i.name} X${i.qty}`).join('\n');
                    const timeStr = new Date().toLocaleString('zh-TW');

                    let msg = `üõí „ÄêÈ∫•È∫•Ë®ÇÂñÆ ${orderId}„Äë\n----------------\n${itemsStr}\n----------------\nüí∞ Á∏ΩÈáëÈ°ç: $${totalPrice.value}`;
                    if (activeGift.value) msg += `\nüéÅ ÊªøÈ°çË¥à: ${activeGift.value}`;
                    msg += `\n\n${settings.value.bankInfo || ''}`;
                    
                    finalMsg.value = msg;

                    // ÈùûÂêåÊ≠•Á¥ÄÈåÑÂà∞Ë©¶ÁÆóË°®
                    try {
                        fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                timestamp: timeStr,
                                id: orderId,
                                itemsText: itemsStr.replace(/\n/g, ', '),
                                totalAmount: totalPrice.value,
                                giftText: activeGift.value || 'ÁÑ°',
                                userId: userProfile.value.userId,
                                userName: userProfile.value.displayName
                            })
                        });
                    } catch (e) {}

                    // Â¶ÇÊûúÂú® LINE ÂÖßÂòóË©¶Áõ¥Êé•ÂÇ≥ÈÄÅ (ÈúÄË¶ÅÈ°çÂ§ñÊ¨äÈôêÔºåÂê¶ÂâáË∑≥ËΩâÂàÜ‰∫´È†Å)
                    if (liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
                        // Ê≠§ËôïÂÉÖÂÖàÈóúÈñâÁµêÂ∏≥Ë¶ñÁ™óÈñãÂïüÊàêÂäüË¶ñÁ™óËÆìÁî®Êà∂ÊâãÂãïÂÇ≥ÈÄÅÊúÄÁ©©
                    }

                    isSubmitting.value = false;
                    cartModal.hide();
                    successModal.show();
                };

                const shareToLine = () => {
                    const url = `https://line.me/R/msg/text/?${encodeURIComponent(finalMsg.value)}`;
                    if (liff.isInClient()) {
                        liff.openWindow({ url, external: true });
                    } else {
                        window.location.href = url;
                    }
                };

                const copyText = () => {
                    const el = document.createElement('textarea');
                    el.value = finalMsg.value;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    hasCopied.value = true;
                    setTimeout(() => hasCopied.value = false, 2000);
                };

                const closeSuccess = () => {
                    successModal.hide();
                    cart.value = {};
                };

                return {
                    products, settings, cart, currentCat, categories, filteredProducts,
                    updateCart, totalQty, totalPrice, cartItems, activeGift, userProfile,
                    handleCheckout, isSubmitting, finalMsg, copyText, hasCopied,
                    shareToLine, openCart: () => cartModal.show(), closeSuccess
                };
            }
        }).mount('#app');
    </script>
</body>
</html>